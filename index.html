<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Редактор діаграм варіантів використання</title>
<style>
body { font-family: Arial, sans-serif; background:#fafafa; margin:0; display:flex; flex-direction:column; align-items:center; }
.controls { display:flex; flex-wrap:wrap; gap:10px; margin:10px; align-items:center; justify-content:center; }
button { background:#4a90e2; color:white; border:none; border-radius:6px; padding:8px 16px; cursor:pointer; font-size:14px; transition:0.2s; }
button:hover { background:#357ab8; }
button.active { background:#2b6cb0; }
#arrowTypeSelector, #usecaseOptions, #contextMenu { display:none; position:absolute; flex-direction:row; background:#fff; border:1px solid #ccc; padding:5px; border-radius:5px; z-index:100; gap:5px; align-items:center; }
#arrowTypeSelector label, #usecaseOptions label { display:flex; flex-direction:column; align-items:center; gap:2px; cursor:pointer; }
svg { border:1px solid #ddd; background-color:#fff; width:90vw; height:80vh; cursor:default; }
text { user-select:none; pointer-events:none; }
.connection { stroke-width:1.5px; }
.association { stroke:#333; }
.include-arrow { stroke:#2b8a3e; }
.extend-arrow { stroke:#a23e48; }
.generalization-arrow { stroke:#4a90e2; }
.stereotype { font-size:12px; fill:#555; }
.connecting { stroke:#999; stroke-dasharray:5,5; }
.selected circle, .selected ellipse, .selected rect { stroke:#ff5733; stroke-width:2px; }
.draggable circle, .draggable ellipse, .draggable rect { cursor:move; }
.controls {position: relative;z-index: 10;}
#arrowTypeSelector {position: absolute;top: 100%;left: 0;transform: translateY(5px);display: none;flex-direction: row;background: #fff;border: 1px solid #ccc;padding: 5px;border-radius: 5px;z-index: 5;}
#usecaseOptions {margin-left: -485px;}
</style>
</head>
<body>

<div class="controls">
  <button id="moveBtn" class="active" onclick="setMode('move')">Рухати</button>
  <button id="connectBtn" onclick="setMode('connect')">З'єднати</button>
  <div id="arrowTypeSelector">
    <label><input type="radio" name="arrowType" value="association" checked>Association</label>
    <label><input type="radio" name="arrowType" value="include">&lt;&lt;include&gt;&gt;</label>
    <label><input type="radio" name="arrowType" value="extend">&lt;&lt;extend&gt;&gt;</label>
    <label><input type="radio" name="arrowType" value="generalization">Generalization</label>
  </div>
  <button id="createUseCaseBtn" onclick="toggleUseCaseMenu()">Створити Use Case</button>
  <div id="usecaseOptions">
    <label>Назва: <input type="text" id="newUseCaseName" value="Use Case"></label>
    <label>Форма: 
      <select id="newUseCaseShape">
        <option value="ellipse">Ellipse</option>
        <option value="rect">Rectangle</option>
      </select>
    </label>
    <label>Колір: <input type="color" id="newUseCaseColor" value="#fef7e0"></label>
    <button onclick="addUseCase()">Додати</button>
  </div>
  <button onclick="addActorPrompt()">Додати Актор</button>
  <button onclick="deleteLastConnection()">Видалити останній зв’язок</button>
  <button onclick="resetPositions()">Скинути позиції</button>
  <button onclick="saveDiagram()">Зберегти</button>
  <button onclick="loadDiagram()">Завантажити</button>
  <button onclick="exportPNG()">Експортувати PNG</button>
  <button onclick="exportSVG()">Експортувати SVG</button>
</div>

<div id="contextMenu">
  <label>Колір: <input type="color" id="contextColor"></label>
  <label id="contextShapeLabel">Форма: 
    <select id="contextShape">
      <option value="ellipse">Ellipse</option>
      <option value="rect">Rectangle</option>
    </select>
  </label>
  <button onclick="applyContextChanges()">Застосувати</button>
</div>

<svg id="diagram">
  <defs>
    <marker id="arrow-association" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#333"/></marker>
    <marker id="arrow-include" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#2b8a3e"/></marker>
    <marker id="arrow-extend" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#a23e48"/></marker>
    <marker id="arrow-generalization" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0,0 L10,5 L0,10 z" fill="#4a90e2"/></marker>
  </defs>
  <g id="connections"></g>
  <g id="actors"></g>
  <g id="usecases"></g>
</svg>

<script>
let mode='move', selectedElement=null, offset={x:0,y:0}, connectingFrom=null, tempLine=null;
const svg=document.getElementById('diagram');
const connectionsGroup=document.getElementById('connections');
const actorsGroup=document.getElementById('actors');
const usecasesGroup=document.getElementById('usecases');
const connections=[];
let actorCount=0;
let contextTarget=null;

// --- Режими ---
function setMode(newMode) {
  mode = newMode;
  document.getElementById('moveBtn').classList.toggle('active', mode === 'move');
  document.getElementById('connectBtn').classList.toggle('active', mode === 'connect');

  const arrowMenu = document.getElementById('arrowTypeSelector');
  arrowMenu.style.display = (mode==='connect') ? 'flex' : 'none';

  document.getElementById('usecaseOptions').style.display='none';

  if (connectingFrom) connectingFrom.classList.remove('selected');
  connectingFrom=null;
  if(tempLine){ tempLine.remove(); tempLine=null; }
}

// --- Меню Use Case ---
function toggleUseCaseMenu(){
  const menu=document.getElementById('usecaseOptions');
  if(menu.style.display==='flex'){menu.style.display='none'; return;}
  document.getElementById('arrowTypeSelector').style.display='none';
  const rect=document.getElementById('createUseCaseBtn').getBoundingClientRect();
  menu.style.left=rect.left+'px';
  menu.style.top=(rect.bottom+5)+'px';
  menu.style.display='flex';
}

// --- Додавання Акторів ---
function addActorPrompt(){
  const name=prompt('Введіть ім’я актора','Актор');
  if(name) addActor(name);
}
function addActor(name='Актор'){
  actorCount++;
  const id='actor'+actorCount;
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('id',id); g.setAttribute('class','draggable actor-group');
  g.setAttribute('transform',`translate(${100+actorCount*30},${100+actorCount*50})`);
  const head=document.createElementNS('http://www.w3.org/2000/svg','circle');
  head.setAttribute('cx',0); head.setAttribute('cy',0); head.setAttribute('r',15);
  head.setAttribute('fill','#e7f3ff'); head.setAttribute('stroke','#333'); head.setAttribute('stroke-width','2');
  g.appendChild(head);
  const body=document.createElementNS('http://www.w3.org/2000/svg','line');
  body.setAttribute('x1',0); body.setAttribute('y1',15); body.setAttribute('x2',0); body.setAttribute('y2',50);
  body.setAttribute('stroke','#333'); body.setAttribute('stroke-width','2'); g.appendChild(body);
  const arms=document.createElementNS('http://www.w3.org/2000/svg','line');
  arms.setAttribute('x1',-25); arms.setAttribute('y1',30); arms.setAttribute('x2',25); arms.setAttribute('y2',30);
  arms.setAttribute('stroke','#333'); arms.setAttribute('stroke-width','2'); g.appendChild(arms);
  const leftLeg=document.createElementNS('http://www.w3.org/2000/svg','line');
  leftLeg.setAttribute('x1',0); leftLeg.setAttribute('y1',50); leftLeg.setAttribute('x2',-20); leftLeg.setAttribute('y2',80);
  leftLeg.setAttribute('stroke','#333'); leftLeg.setAttribute('stroke-width','2'); g.appendChild(leftLeg);
  const rightLeg=document.createElementNS('http://www.w3.org/2000/svg','line');
  rightLeg.setAttribute('x1',0); rightLeg.setAttribute('y1',50); rightLeg.setAttribute('x2',20); rightLeg.setAttribute('y2',80);
  rightLeg.setAttribute('stroke','#333'); rightLeg.setAttribute('stroke-width','2'); g.appendChild(rightLeg);
  const label=document.createElementNS('http://www.w3.org/2000/svg','text');
  label.setAttribute('x',0); label.setAttribute('y',95); label.setAttribute('text-anchor','middle'); label.textContent=name;
  g.appendChild(label);
  actorsGroup.appendChild(g);
  makeDraggable(g);
  addClickHandlers(g,label);
}

// --- Додавання Use Case ---
function addUseCase(){
  const name=document.getElementById('newUseCaseName').value||'Use Case';
  const shape=document.getElementById('newUseCaseShape').value;
  const color=document.getElementById('newUseCaseColor').value||'#fef7e0';
  const id='usecase'+(usecasesGroup.childNodes.length+1);
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('id',id); g.setAttribute('class','draggable usecase');
  g.setAttribute('transform','translate(400,200)');
  let elem;
  if(shape==='ellipse'){ elem=document.createElementNS('http://www.w3.org/2000/svg','ellipse'); elem.setAttribute('cx',0); elem.setAttribute('cy',0); elem.setAttribute('rx',80); elem.setAttribute('ry',30); }
  else{ elem=document.createElementNS('http://www.w3.org/2000/svg','rect'); elem.setAttribute('x',-80); elem.setAttribute('y',-30); elem.setAttribute('width',160); elem.setAttribute('height',60); elem.setAttribute('rx',10); elem.setAttribute('ry',10);}
  elem.setAttribute('fill',color); elem.setAttribute('stroke','#333'); elem.setAttribute('stroke-width','1.5'); g.appendChild(elem);
  const label=document.createElementNS('http://www.w3.org/2000/svg','text');
  label.setAttribute('x',0); label.setAttribute('y',5); label.setAttribute('text-anchor','middle'); label.textContent=name;
  g.appendChild(label);
  usecasesGroup.appendChild(g);
  makeDraggable(g);
  addClickHandlers(g,label);
  document.getElementById('usecaseOptions').style.display='none';
}

// --- Dragging ---
function makeDraggable(element){ element.addEventListener('mousedown', startDrag); }
function startDrag(evt){
  if(mode!=='move') return;
  selectedElement=evt.currentTarget;
  const pos=getMousePosition(evt);
  const transform=selectedElement.getAttribute('transform');
  const translate=transform.match(/translate\(([-\d.]+),\s*([-\d.]+)\)/);
  offset.x=pos.x-parseFloat(translate[1]);
  offset.y=pos.y-parseFloat(translate[2]);
  svg.addEventListener('mousemove', drag);
  svg.addEventListener('mouseup', endDrag);
}
function drag(evt){
  if(selectedElement){
    const pos=getMousePosition(evt);
    const x=pos.x-offset.x, y=pos.y-offset.y;
    selectedElement.setAttribute('transform',`translate(${x},${y})`);
    updateConnections(selectedElement.id);
  }
}
function endDrag(){ svg.removeEventListener('mousemove',drag); svg.removeEventListener('mouseup',endDrag); selectedElement=null; }
function getMousePosition(evt){ const CTM=svg.getScreenCTM(); return { x:(evt.clientX-CTM.e)/CTM.a, y:(evt.clientY-CTM.f)/CTM.d }; }

// --- Click Handlers ---
function addClickHandlers(element,label){
  element.addEventListener('click', function(evt){
    if(mode==='connect'){
      evt.stopPropagation();
      if(!connectingFrom){ connectingFrom=element; element.classList.add('selected'); }
      else if(connectingFrom!==element){ createConnection(connectingFrom, element); connectingFrom.classList.remove('selected'); connectingFrom=null; if(tempLine){ tempLine.remove(); tempLine=null;} }
    }
  });
  element.addEventListener('contextmenu', function(evt){ showContextMenu(evt, element); });
  element.addEventListener('dblclick', function(evt){ const newText=prompt('Введіть новий текст', label.textContent); if(newText!==null) label.textContent=newText; });
}

// --- Connections ---
svg.addEventListener('mousemove', function(evt){
  if(mode==='connect' && connectingFrom){
    const CTM=svg.getScreenCTM();
    const x=(evt.clientX-CTM.e)/CTM.a;
    const y=(evt.clientY-CTM.f)/CTM.d;
    const fromPos=getElementPosition(connectingFrom);
    if(!tempLine){ tempLine=document.createElementNS('http://www.w3.org/2000/svg','line'); tempLine.classList.add('connecting'); connectionsGroup.appendChild(tempLine);}
    tempLine.setAttribute('x1',fromPos.x); tempLine.setAttribute('y1',fromPos.y);
    tempLine.setAttribute('x2',x); tempLine.setAttribute('y2',y);
  }
});
function getElementPosition(element){
  const transform=element.getAttribute('transform');
  const match=transform.match(/translate\(([-\d.]+),\s*([-\d.]+)\)/);
  return { x:parseFloat(match[1]), y:parseFloat(match[2]) };
}
function createConnection(from,to){
  const arrowType=document.querySelector('input[name="arrowType"]:checked').value;
  const fromPos=getElementPosition(from); const toPos=getElementPosition(to);
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',fromPos.x); line.setAttribute('y1',fromPos.y);
  line.setAttribute('x2',toPos.x); line.setAttribute('y2',toPos.y);
  line.dataset.from=from.id; line.dataset.to=to.id; line.classList  .add('connection');

  let labelElem = null;
  switch(arrowType){
    case 'association':
      line.classList.add('association');
      line.setAttribute('marker-end','url(#arrow-association)');
      break;
    case 'include':
      line.classList.add('include-arrow');
      line.setAttribute('marker-end','url(#arrow-include)');
      labelElem = createLabel(fromPos,toPos,'<<include>>');
      break;
    case 'extend':
      line.classList.add('extend-arrow');
      line.setAttribute('marker-end','url(#arrow-extend)');
      labelElem = createLabel(fromPos,toPos,'<<extend>>');
      break;
    case 'generalization':
      line.classList.add('generalization-arrow');
      line.setAttribute('marker-end','url(#arrow-generalization)');
      break;
  }

  connectionsGroup.appendChild(line);
  if(labelElem) connectionsGroup.appendChild(labelElem);
  connections.push({line,label:labelElem});
  saveDiagram();
}

// --- Labels for connections ---
function createLabel(from,to,text){
  const midX=(from.x+to.x)/2;
  const midY=(from.y+to.y)/2-5;
  const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
  lbl.setAttribute('x',midX);
  lbl.setAttribute('y',midY);
  lbl.setAttribute('text-anchor','middle');
  lbl.setAttribute('fill','#555');
  lbl.setAttribute('font-size','12');
  lbl.textContent=text;
  return lbl;
}

// --- Update connection positions when nodes move ---
function updateConnections(id){
  connections.forEach(c=>{
    if(c.line.dataset.from===id || c.line.dataset.to===id){
      const fromPos=getElementPosition(document.getElementById(c.line.dataset.from));
      const toPos=getElementPosition(document.getElementById(c.line.dataset.to));
      c.line.setAttribute('x1',fromPos.x); c.line.setAttribute('y1',fromPos.y);
      c.line.setAttribute('x2',toPos.x); c.line.setAttribute('y2',toPos.y);
      if(c.label){
        c.label.setAttribute('x',(fromPos.x+toPos.x)/2);
        c.label.setAttribute('y',(fromPos.y+toPos.y)/2-5);
      }
    }
  });
}

// --- Save/Load Diagram ---
function saveDiagram(){
  const data={actors:[], usecases:[], connections:[]};
  
  actorsGroup.childNodes.forEach(a=>{
    data.actors.push({id:a.id, label:a.querySelector('text').textContent, transform:a.getAttribute('transform')});
  });

  usecasesGroup.childNodes.forEach(u=>{
    const elem=u.querySelector('ellipse,rect');
    data.usecases.push({
      id:u.id,
      label:u.querySelector('text').textContent,
      transform:u.getAttribute('transform'),
      shape:elem.tagName,
      color:elem.getAttribute('fill')
    });
  });

  connections.forEach(c=>{
    let t='association';
    if(c.line.classList.contains('include-arrow')) t='include';
    else if(c.line.classList.contains('extend-arrow')) t='extend';
    else if(c.line.classList.contains('generalization-arrow')) t='generalization';
    const from=c.line.dataset.from;
    const to=c.line.dataset.to;
    const label=c.label ? c.label.textContent : null;
    data.connections.push({from,to,type:t,label});
  });

  localStorage.setItem('diagramData', JSON.stringify(data));
  console.log('Діаграма збережена');
}

function loadDiagram() {
  const dataStr = localStorage.getItem('diagramData');
  if(!dataStr) { alert('Немає збережених даних'); return; }
  const data = JSON.parse(dataStr);

  // --- Очищення ---
  actorsGroup.innerHTML='';
  usecasesGroup.innerHTML='';
  connectionsGroup.innerHTML='';
  connections.length = 0;

  // --- Відновлення акторів ---
  data.actors.forEach(a=>{
    const id = a.id;
    const name = a.label;
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('id', id);
    g.setAttribute('class','draggable actor-group');
    g.setAttribute('transform', a.transform);

    // Голова
    const head=document.createElementNS('http://www.w3.org/2000/svg','circle');
    head.setAttribute('cx',0); head.setAttribute('cy',0); head.setAttribute('r',15);
    head.setAttribute('fill','#e7f3ff'); head.setAttribute('stroke','#333'); head.setAttribute('stroke-width','2');
    g.appendChild(head);

    // Тіло
    const body=document.createElementNS('http://www.w3.org/2000/svg','line');
    body.setAttribute('x1',0); body.setAttribute('y1',15); body.setAttribute('x2',0); body.setAttribute('y2',50);
    body.setAttribute('stroke','#333'); body.setAttribute('stroke-width','2'); g.appendChild(body);

    // Руки
    const arms=document.createElementNS('http://www.w3.org/2000/svg','line');
    arms.setAttribute('x1',-25); arms.setAttribute('y1',30); arms.setAttribute('x2',25); arms.setAttribute('y2',30);
    arms.setAttribute('stroke','#333'); arms.setAttribute('stroke-width','2'); g.appendChild(arms);

    // Ноги
    const leftLeg=document.createElementNS('http://www.w3.org/2000/svg','line');
    leftLeg.setAttribute('x1',0); leftLeg.setAttribute('y1',50); leftLeg.setAttribute('x2',-20); leftLeg.setAttribute('y2',80);
    leftLeg.setAttribute('stroke','#333'); leftLeg.setAttribute('stroke-width','2'); g.appendChild(leftLeg);
    const rightLeg=document.createElementNS('http://www.w3.org/2000/svg','line');
    rightLeg.setAttribute('x1',0); rightLeg.setAttribute('y1',50); rightLeg.setAttribute('x2',20); rightLeg.setAttribute('y2',80);
    rightLeg.setAttribute('stroke','#333'); rightLeg.setAttribute('stroke-width','2'); g.appendChild(rightLeg);

    // Підпис
    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',0); label.setAttribute('y',95); label.setAttribute('text-anchor','middle'); label.textContent=name;
    g.appendChild(label);

    actorsGroup.appendChild(g);
    makeDraggable(g);
    addClickHandlers(g,label);
  });

  // --- Відновлення use cases ---
  data.usecases.forEach(u=>{
    const id = u.id;
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('id', id);
    g.setAttribute('class','draggable usecase');
    g.setAttribute('transform', u.transform);

    let elem;
    if(u.shape==='ellipse'){
      elem=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
      elem.setAttribute('cx',0); elem.setAttribute('cy',0); elem.setAttribute('rx',80); elem.setAttribute('ry',30);
    } else {
      elem=document.createElementNS('http://www.w3.org/2000/svg','rect');
      elem.setAttribute('x',-80); elem.setAttribute('y',-30); elem.setAttribute('width',160); elem.setAttribute('height',60);
      elem.setAttribute('rx',10); elem.setAttribute('ry',10);
    }
    elem.setAttribute('fill', u.color); elem.setAttribute('stroke','#333'); elem.setAttribute('stroke-width','1.5');
    g.appendChild(elem);

    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',0); label.setAttribute('y',5); label.setAttribute('text-anchor','middle'); label.textContent=u.label;
    g.appendChild(label);

    usecasesGroup.appendChild(g);
    makeDraggable(g);
    addClickHandlers(g,label);
  });

  // --- Відновлення зв’язків ---
  data.connections.forEach(c=>{
    const from = document.getElementById(c.from);
    const to = document.getElementById(c.to);
    if(from && to){
      const arrowType = c.type;
      const fromPos = getElementPosition(from);
      const toPos = getElementPosition(to);

      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',fromPos.x); line.setAttribute('y1',fromPos.y);
      line.setAttribute('x2',toPos.x); line.setAttribute('y2',toPos.y);
      line.dataset.from = c.from; line.dataset.to = c.to;
      line.classList.add('connection');

      let labelElem = null;
      switch(arrowType){
        case 'association': line.classList.add('association'); line.setAttribute('marker-end','url(#arrow-association)'); break;
        case 'include': line.classList.add('include-arrow'); line.setAttribute('marker-end','url(#arrow-include)'); if(c.label) labelElem=createLabel(fromPos,toPos,c.label); break;
        case 'extend': line.classList.add('extend-arrow'); line.setAttribute('marker-end','url(#arrow-extend)'); if(c.label) labelElem=createLabel(fromPos,toPos,c.label); break;
        case 'generalization': line.classList.add('generalization-arrow'); line.setAttribute('marker-end','url(#arrow-generalization)'); break;
      }

      connectionsGroup.appendChild(line);
      if(labelElem) connectionsGroup.appendChild(labelElem);
      connections.push({line,label:labelElem});
    }
  });

  console.log('Діаграма завантажена');
}

window.addEventListener('load', loadDiagram);
</script>